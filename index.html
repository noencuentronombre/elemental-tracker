<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elemental Card Tracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arial">
  <style>
    /* (same CSS styling as before, for brevity skipped here to save space) */
  </style>
</head>
<body>
  <!-- UI Elements -->
  <!-- (same HTML structure: buttons, form, table, etc) -->

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBEr6Zg5Al6bSl8mxWJQQrqBJX84WMHBtI",
      authDomain: "elementalcards3.firebaseapp.com",
      projectId: "elementalcards3",
      storageBucket: "elementalcards3.firebasestorage.app",
      messagingSenderId: "811010736419",
      appId: "1:811010736419:web:7fe616fd9ed1d30d648c96"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentClass = 'Year 7';
    let classData = { 'Year 7': {}, 'Year 12': {} };
    let studentData = classData[currentClass];
    let editMode = false;

    const defaultCards = ['Water', 'Fire', 'Earth', 'Air', 'Lightning', 'Diamond', 'Shadow', 'Time', 'Metal'];
    const tokenTypes = ['Water', 'Fire', 'Earth', 'Air', 'Lightning'];
    const cardEmojis = { Water: "üíß", Fire: "üî•", Earth: "üçÉ", Air: "üå¨Ô∏è", Lightning: "‚ö°", Diamond: "üíé", Shadow: "üåë", Time: "‚è≥", Metal: "üö†Ô∏è" };
    const tokenIcons = { Water: "üíß", Fire: "üî•", Earth: "üçÉ", Air: "üå™Ô∏è", Lightning: "‚ö°" };

    async function loadData() {
      const doc = await db.collection("tracker").doc("cardData").get();
      if (doc.exists) {
        classData = doc.data();
        studentData = classData[currentClass];
        updateTable();
      }
    }

    async function saveData() {
      await db.collection("tracker").doc("cardData").set(classData);
    }

    function addCard() {
      let names = document.getElementById("studentName").value.trim().split(",").map(n => n.trim());
      let type = document.getElementById("cardType").value;
      let mode = document.getElementById("addMode").value;
      if (!names[0]) return alert("Enter at least one student name.");
      names.forEach(name => {
        if (!studentData[name]) {
          studentData[name] = { tokens: [], heldBy: "teacher" };
          defaultCards.forEach(c => studentData[name][c] = 0);
        }
        if (mode === "token") {
          studentData[name].tokens.push(type);
        } else {
          studentData[name][type]++;
        }
      });
      updateTable();
      saveData();
    }

    function switchClass() {
      currentClass = currentClass === 'Year 7' ? 'Year 12' : 'Year 7';
      document.getElementById('currentClassLabel').textContent = currentClass;
      document.getElementById('classSwitchBtn').textContent = `Switch to ${currentClass === 'Year 7' ? 'Year 12' : 'Year 7'}`;
      if (!classData[currentClass]) classData[currentClass] = {};
      studentData = classData[currentClass];
      updateTable();
    }

    function updateTable() {
      const table = document.getElementById("cardTable");
      table.innerHTML = "";

      for (let name in studentData) {
        const s = studentData[name];
        let row = `<tr><td>${name}</td>`;

        const tokenCounts = {};
        (s.tokens || []).forEach(t => tokenCounts[t] = (tokenCounts[t] || 0) + 1);
        let tokenDisplay = Object.entries(tokenCounts).map(([type, count]) =>
          `<span class="token-icon">${tokenIcons[type]}${count > 1 ? ' x' + count : ''}</span>`
        ).join(' ');
        row += `<td>${tokenDisplay}</td>`;

        tokenTypes.forEach(type => {
          while ((s.tokens || []).filter(t => t === type).length >= 3) {
            s.tokens.splice(s.tokens.indexOf(type), 3);
            s[type]++;
          }
        });

        defaultCards.forEach(card => {
          if (editMode && name !== "CLASS") {
            row += `<td><select onchange="updateCardValue('${name}', '${card}', this.value)">` +
              [...Array(11).keys()].map(i => `<option value="${i}" ${i == s[card] ? "selected" : ""}>${i}</option>`).join("") +
              `</select></td>`;
          } else {
            row += `<td>${s[card] > 0 ? `<span class="emoji">${cardEmojis[card]}</span> x${s[card]}` : ""}</td>`;
          }
        });

        row += `<td>${name === "CLASS" ? "" : `<button class="held-by-button" onclick="toggleHeldBy('${name}')">${s.heldBy === "student" ? "üßç" : "üì•"}</button>`}</td>`;
        row += `<td>${name === "CLASS" ? "" : `<button onclick="removeStudent('${name}')">‚ùå</button>`}</td>`;
        table.innerHTML += row;
      }
    }

    function updateCardValue(student, card, value) {
      studentData[student][card] = parseInt(value);
      saveData();
    }

    function toggleHeldBy(name) {
      studentData[name].heldBy = studentData[name].heldBy === "student" ? "teacher" : "student";
      updateTable();
      saveData();
    }

    function removeStudent(name) {
      if (confirm(`Remove ${name}?`)) {
        delete studentData[name];
        updateTable();
        saveData();
      }
    }

    function clearData() {
      if (confirm("Clear all data?")) {
        classData[currentClass] = {};
        studentData = classData[currentClass];
        updateTable();
        saveData();
      }
    }

    function exportData() {
      let tsv = "Student\tTokens\t" + defaultCards.join("\t") + "\tHeld By\n";
      for (let name in studentData) {
        const s = studentData[name];
        const tokenString = (s.tokens || []).join(",");
        const line = [name, tokenString, ...defaultCards.map(c => s[c] || 0), s.heldBy || ""].join("\t");
        tsv += line + "\n";
      }
      const blob = new Blob([tsv], { type: "text/tab-separated-values" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${currentClass}_CardTracker.tsv`;
      link.click();
    }

    function undoLastCombo() {
      alert("Undo feature not yet implemented.");
    }

    function toggleEditMode() {
      editMode = !editMode;
      updateTable();
    }

    function handleComboClick(comboType) {
      alert(`Combo clicked: ${comboType}`); // Add full logic if needed
    }

    loadData();
  </script>
</body>
</html>
